# Зачем нужен мониторинг

Без сбора логов и трейсинг-запросов прожить можно, без метрик и мониторинга - нет.  
Система мониторинга - это система сбора метрик.  
Метрики - sets of numbers that give information about a particular process or activity. То есть это всегда цифры.  
Из системы мониторинга не нужно собирать трейсинги и логи (поскольку метрики - это только цифры).  

## Группы метрик

**System-level performance metrics**  

  - относятся к серверам или ВМ
  - загруженность CPU, утилизацию памяти, ввод-вывод

**Application-level performance metrics**  

  - относятся к показателям работы приложения
  - I/O на уровне приложения, использование кэша, кол-во запросов итд

**Server availability and uptime metrics** - доступность, получаемая с помощью хелсчеков

**Business-level metrics** - абстрактные метрики, напрямую не связанные с приложением или утилизацией ресурсов. Например, кол-во заказов в час для интернет-магазина. Эти метрики наиболее приоритетные, они выводятся на дашборды и с ними связаны приоритетные инциденты.

Прометей не предназначен для длительного хранения метрик, в среднем до 14 дней, для длительного хранения нужна федерация с серией серверов с разной частотой скрейпинга.  

## Что мониторить

2 метода - **USE** и RED

**RED**:

(Request) Rate - the number of requests, per second, your services are serving.
(Request) Errors - the number of failed requests per second.
(Request) Duration - The amount of time each request takes expressed as a time interval.

**USE**:

Resource: all physical server functional components (CPUs, disks, busses, ...) [1]

For every resource:
Utilization: the average time that the resource was busy servicing work [2]
Saturation: the degree to which the resource has extra work which it can't service, often queued
Errors: the count of error events

## Алертинг

Без алертов мониторинг - бесполезная штука, так как десятки тысяч метрик ни один инженер не обработает и не отреагирует вовремя.  
Нужна автоматизация.  

**Первый тип алертинга** - молчаливые обезьяны: ничего не вижу, не слышу и никому не скажу.  
Это когда уведомления приходят слишком поздно либо вообще не приходят.  

**Второй тип** - пастух из басни, который кричит про волков, а когда волки реально приходят - ему никто не верит и всех овец съедают. Приходит огромное кол-во уведомлений - alert flooding.  

**Третий тип** - хорошо настроенная система алертинга.  
Правила такой системы: (правильные паттерны)  

  - алертинг только тех событий, которые требуют вмешательства инженера (когда кончается место на диске итд)  
  - любой алерт, который влечет за собой изменения в системе (чтобы далее не получать этот алерт - апдейты безопасности, обновление ПО итд)  
  - алерты прорабатывать совместно с разработчиками и бизнесом  
  - периодический анализ нагрузки исходя из отчетов мониторинга  
  - service discovery - автоматизированное обнаружение и подключение систем к системе мониторинга. В контексте Прометея: Prometheus service discovery is a standard method of finding endpoints to scrape for metrics.  

Как делать не надо

  - настраивать все вручную и вручную добавлять серверы к системе мониторинга  
  - алертинг на основании мониторинга ресурсов (потребление CPU памяти итд) - приводит к **alert flooding** и **false positive alerts** (например для приложений со скачками потребления CPU, что для приложения является нормальной работой)  
  - выделенные роли для специалиста по мониторингу (тогда как надо в первую очередь привлекать разработчиков для прикладных и бизнесовых метрик) 
  - использование единого инструмента для мониторинга, логирования, трейсинга запросов - про то, когда система мониторинга используется не по назначению. <u>Мониторинг - это только сбор метрик и это всегда цифры</u>!

## Monitoring and Observability

Все компании хотят **observability**, никому недостаточно только лишь мониторинга.  
Раньше были только физические сервера. На них работали монолитные приложения, базы данных.  
Система мониторинга выполняла ограниченный круг задач - доступность и отдельные метрики по производительности.  
Изменился IT-ландшафт, появился доступный интернет, микросервисы и повысились требования к сервисам.  
Облака привели к тому, что возросло кол-во сущностей - теперь это сотни виртуальных машин и тысячи контейнеров даже в средней компании. Появилась потребность в Service discovery.  

Работать с логами как раньше тоже не получалось - найти на тысячах сущностей нужный лог это сложно -> новый класс ПО - это логгинг-серверы. Это централизованный сборщик логов с веб-интерфейсов с поиском и фильтром по логам + опционально система алертинга на основе логов.  
С появлением микросервисов появилась нужда в трейсинг-серверах. Так как очень много взаимодействий между сервисами и непонятно где и на каком этапе появляются задержки и таймауты.  
Требования стабильности - об ошибках теперь требуется узнавать как можно раньше, причем и об ошибках, которые возникают на клиентской стороне (фронт-энд). Это из-за того, что все большая часть кода теперь выполняется на клиентской стороне -> появились Error Tracking-системы (например Sentry)  

Observability нужен не всем, но знать про него нужно каждому.  
  - Service Discovery  
  - централизованное логирование
  - трейсинг запросов для микросервисов
  - сбор и отслеживание ошибок

# Установка Prometheus

## Введение



## Установка в Kubernetes



## Разбор специфичных exporter-ов



# Тюнинг Prometheus

## Config-файлы Prometheus



## Service Discovery в Prometheus



## Установка приложения на сбор метрик



## Мониторинг в Kubernetes на BlackBox



## Promtool и советы по Prometheus



# Продвинутый Prometheus

## Построение федерации



## Подключение внешних Long-term storage (Victoria Metrics)



# Grafana

## Grafana Enterprise



## Установка в Kubernetes



## Источники данных (data source)



## Dashboards. Готовые и собственные



## Организация пользователей и доступов (org, teams, LDAP)



## Provisioning



# Prometheus Operator

## Общие сведения и установка



## Настройка мониторинга ресурсов



# Логирование



# Error Reporting



# Tracing



# Мониторинг и логирование Kubernetes в Production